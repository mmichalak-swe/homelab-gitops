services:
  wud:
    image: getwud/wud:8.1.1
    container_name: wud
    hostname: wud
    restart: unless-stopped
    depends_on:
      wud-socket-proxy:
        condition: service_healthy
    expose:
      - 3000
    environment:
      - TZ=${TZ}
      - WUD_SERVER_PORT=${WUD_SERVER_PORT}
      - WUD_TRIGGER_DISCORD_1_URL=${WUD_TRIGGER_DISCORD_1_URL}
      - WUD_WATCHER_RASPBERRYPI4_HOST=${WUD_WATCHER_RASPBERRYPI4_HOST}
      - WUD_WATCHER_RASPBERRYPI4_PORT=${WUD_WATCHER_RASPBERRYPI4_PORT}
      - WUD_WATCHER_RASPBERRYPI4_CRON=${WUD_WATCHER_RASPBERRYPI4_CRON}
      - WUD_WATCHER_RASPBERRYPI4_WATCHALL=${WUD_WATCHER_RASPBERRYPI4_WATCHALL}
      - WUD_WATCHER_RASPBERRYPI4_WATCHEVENTS=${WUD_WATCHER_RASPBERRYPI4_WATCHEVENTS}
      - WUD_WATCHER_RASPBERRYPI4_WATCHATSTART=${WUD_WATCHER_RASPBERRYPI4_WATCHATSTART}
      - WUD_LOG_LEVEL=${WUD_LOG_LEVEL}
      - WUD_REGISTRY_HUB_PUBLIC_AUTH=${WUD_REGISTRY_HUB_PUBLIC_AUTH}
      - WUD_AUTH_OIDC_AUTHELIA_DISCOVERY=${WUD_AUTH_OIDC_AUTHELIA_DISCOVERY}
      - WUD_AUTH_OIDC_AUTHELIA_CLIENTID=${WUD_AUTH_OIDC_AUTHELIA_CLIENTID}
      - WUD_AUTH_OIDC_AUTHELIA_CLIENTSECRET=${WUD_AUTH_OIDC_AUTHELIA_CLIENTSECRET}
      - WUD_WATCHER_GMKG3_HOST=${WUD_WATCHER_GMKG3_HOST}
      - WUD_WATCHER_GMKG3_PORT=${WUD_WATCHER_GMKG3_PORT}
      - WUD_WATCHER_GMKG3_CAFILE=${WUD_WATCHER_GMKG3_CAFILE}
      - WUD_WATCHER_GMKG3_CERTFILE=${WUD_WATCHER_GMKG3_CERTFILE}
      - WUD_WATCHER_GMKG3_KEYFILE=${WUD_WATCHER_GMKG3_KEYFILE}
      - WUD_WATCHER_GMKG3_CRON=${WUD_WATCHER_GMKG3_CRON}
      - WUD_WATCHER_GMKG3_WATCHALL=${WUD_WATCHER_GMKG3_WATCHALL}
      - WUD_WATCHER_GMKG3_WATCHEVENTS=${WUD_WATCHER_GMKG3_WATCHEVENTS}
      - WUD_WATCHER_GMKG3_WATCHATSTART=${WUD_WATCHER_GMKG3_WATCHATSTART}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:$WUD_SERVER_PORT/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      - store:/store
      - certs:/certs
    networks:
      pihole-net:
        ipv4_address: 172.18.0.30
      proxy-net:
    logging:
      driver: "json-file"
      options:
        max-size: "64m"
    labels:
      - 'wud.display.icon=sh:wud'
      - 'wud.tag.include=^\d+\.\d+\.\d+$$'
      - 'wud.link.template=https://github.com/getwud/wud/releases/tag/$${major}.$${minor}.$${patch}'


  wud-socket-proxy:
    image: tecnativa/docker-socket-proxy:v0.4.2
    container_name: wud-socket-proxy
    hostname: wud-socket-proxy
    expose:
      - 2375
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:2375/_ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    environment:
      - LOG_LEVEL=info
      - SOCKET_PATH=/var/run/docker.sock
      # Defaults (safe)
      - EVENTS=1
      - PING=1
      - VERSION=1
      # Read-only monitoring for WUD
      - CONTAINERS=1
      - IMAGES=1
      - INFO=1
      - POST=0
      - SYSTEM=0
      - EXEC=0
      - NETWORKS=0
      - VOLUMES=0
      - PLUGINS=0
      - SERVICES=0
      - SWARM=0
      - TASKS=0
      - NODES=0
      - CONFIGS=0
      - SECRETS=0
      - BUILD=0
      - COMMIT=0
      - DISTRIBUTION=0
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      proxy-net:
    logging:
      driver: "json-file"
      options:
        max-size: "64m"


volumes:
  store:
  certs:


networks:
  pihole-net:
    name: pihole_docker_pihole-net
    external: true
  proxy-net:
    name: wud_sp_net
    driver: bridge
    internal: true
