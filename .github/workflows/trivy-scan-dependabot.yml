name: Trivy Scan Dependabot PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  trivy:
    runs-on: ubuntu-latest
    if: github.event.pull_request.base.ref == 'main' && github.actor == 'dependabot[bot]'

    steps:
      - uses: actions/checkout@v4

      #########################
      # Install yq
      #########################
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      #########################
      # Detect changed compose file
      #########################
      - name: Find changed compose files
        id: changed
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/compose.yml
            **/compose.yaml

      #########################
      # Extract bumped image
      #########################
      - name: Extract bumped image
        id: image
        run: |
          FILE="${{ steps.changed.outputs.all_changed_files }}"
          if [ -z "$FILE" ]; then
            echo "image=" >> $GITHUB_OUTPUT
            exit 0
          fi

          IMG=$(yq '.services.*.image' "$FILE" | grep -v null | head -n 1)
          echo "Image found: $IMG"
          echo "image=$IMG" >> $GITHUB_OUTPUT

      - name: Stop if no image found
        if: steps.image.outputs.image == ''
        run: echo "No image found â€” exiting."

      #########################
      # Run Trivy scans
      #########################
      - name: Run Trivy (table output)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ steps.image.outputs.image }}
          format: table
          output: trivy-table.txt
          exit-code: 0

      - name: Run Trivy (SARIF output)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ steps.image.outputs.image }}
          format: sarif
          output: trivy.sarif
          exit-code: 0

      #########################
      # Upload SARIF + table artifact
      #########################
      - name: Upload SARIF result
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy.sarif

      - name: Upload table report artifact
        uses: actions/upload-artifact@v4
        with:
          name: trivy-table
          path: trivy-table.txt
          retention-days: 30

      #########################
      # Generate a simple summary
      #########################
      - name: Generate summary of HIGH/CRITICAL vulns
        id: summary
        run: |
          HIGH=$(grep -c "HIGH" trivy-table.txt || true)
          CRIT=$(grep -c "CRITICAL" trivy-table.txt || true)

          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "crit=$CRIT" >> $GITHUB_OUTPUT

      #########################
      # PR Comment
      #########################
      - name: Comment on PR with scan summary
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: trivy-scan
          message: |
            ## ğŸ” Trivy Scan Summary (Dependabot â†’ main)

            **Image Scanned:**  
            `${{ steps.image.outputs.image }}`

            ### ğŸ›¡ Vulnerabilities
            | Severity | Count |
            |----------|-------|
            | HIGH | `${{ steps.summary.outputs.high }}` |
            | CRITICAL | `${{ steps.summary.outputs.crit }}` |

            ### ğŸ“„ Full Reports
            **Workflow Artifacts (Full Trivy Table Output)**  
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts

            **SARIF Security Dashboard**  
            ${{ github.server_url }}/${{ github.repository }}/security/code-scanning

            _This scan does not block merges â€” informational only._
