name: Trivy Scan Dependabot PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  discover-images:
    runs-on: ubuntu-latest
    if: github.event.pull_request.base.ref == 'main' && github.actor == 'dependabot[bot]'
    outputs:
      images: ${{ steps.images.outputs.images_json }}
    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        uses: dcarbone/install-jq-action@v3
        with:
          version: '1.7.1'

      - name: Install yq
        uses: mikefarah/yq@v4

      - name: Find changed compose files
        id: changed
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/compose.yml
            **/compose.yaml

      - name: Extract images from changed compose files
        id: images
        run: |
          declare -a IMAGES_ARR=()

          FILES="${{ steps.changed.outputs.all_changed_files }}"
          for FILE in $FILES; do
            [ -f "$FILE" ] || continue
            FOUND=$(yq '.services.*.image' "$FILE" | grep -v null || true)
            if [ -n "$FOUND" ]; then
              while IFS= read -r img; do
                [ -z "$img" ] && continue
                IMAGES_ARR+=("$img")
              done <<< "$FOUND"
            fi
          done

          IMAGES=$(printf '%s\n' "${IMAGES_ARR[@]}" | sed '/^$/d' | sort -u)
          IMAGES_JSON=$(printf '%s\n' "$IMAGES" | jq -R . | jq -s .)
          echo "images_json=$IMAGES_JSON" >> "$GITHUB_OUTPUT"

  trivy:
    needs: discover-images
    runs-on: ubuntu-latest
    if: needs.discover-images.outputs.images != '[]' && needs.discover-images.outputs.images != ''
    strategy:
      fail-fast: false
      matrix:
        image: ${{ fromJson(needs.discover-images.outputs.images) }}
    steps:
      - uses: actions/checkout@v4

      - name: Set weekly cache key
        run: echo "WEEK=$(date +'%G%V')" >> "$GITHUB_ENV"

      - name: Cache Trivy DB (rotates weekly)
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ runner.os }}-${{ env.WEEK }}
          restore-keys: |
            trivy-db-${{ runner.os }}-

      - name: Install jq
        uses: dcarbone/install-jq-action@v3
        with:
          version: '1.7.1'

      - name: Trivy scan (JSON)
        uses: aquasecurity/trivy-action@0.33.1
        env:
          TRIVY_CACHE_DIR: ~/.cache/trivy
        with:
          image-ref: ${{ matrix.image }}
          format: json
          output: trivy.json
          vuln-type: os,library
          timeout: 10m
          ignore-unfixed: false
          exit-code: 0

      - name: Summarize severities
        id: sev
        run: |
          SAFE=$(echo "${{ matrix.image }}" | tr '/: ' '__-')
          echo "SAFE=$SAFE" >> "$GITHUB_ENV"
          HIGH=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy.json)
          CRIT=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy.json)
          {
            echo "image=${{ matrix.image }}"
            echo "high=$HIGH"
            echo "critical=$CRIT"
          } > "summary-${SAFE}.txt"

      - name: Upload per-image JSON
        uses: actions/upload-artifact@v4
        with:
          name: trivy-json-${{ env.SAFE }}
          path: trivy.json
          retention-days: 30

      - name: Upload per-image summary
        uses: actions/upload-artifact@v4
        with:
          name: trivy-summary-${{ env.SAFE }}
          path: summary-${{ env.SAFE }}.txt
          retention-days: 30

  comment:
    needs: [discover-images, trivy]
    runs-on: ubuntu-latest
    if: always() && needs.discover-images.outputs.images != '[]' && needs.discover-images.outputs.images != ''
    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        uses: dcarbone/install-jq-action@v3
        with:
          version: '1.7.1'

      - name: Download summaries
        uses: actions/download-artifact@v4
        with:
          path: summaries

      - name: Build PR comment
        id: build
        run: |
          echo "## ðŸ” Trivy Vulnerability Scan Summary (Dependabot â†’ main)" > comment.md
          echo "" >> comment.md
          echo "Images scanned:" >> comment.md
          echo '```' >> comment.md
          printf '%s' '${{ needs.discover-images.outputs.images }}' | jq -r '.[]' >> comment.md
          echo '```' >> comment.md
          echo "" >> comment.md
          echo "### Per-image vulnerabilities" >> comment.md
          echo "" >> comment.md

          for f in summaries/**/summary-*.txt; do
            [ -f "$f" ] || continue
            IMG=$(grep '^image=' "$f" | cut -d= -f2-)
            HIGH=$(grep '^high=' "$f" | cut -d= -f2)
            CRIT=$(grep '^critical=' "$f" | cut -d= -f2)
            {
              echo "Image: \`$IMG\`"
              echo ""
              echo "| Severity | Count |"
              echo "|----------|-------|"
              echo "| HIGH     | ${HIGH} |"
              echo "| CRITICAL | ${CRIT} |"
              echo ""
              echo "---"
              echo ""
            } >> comment.md
          done

          echo "message<<EOF" >> "$GITHUB_OUTPUT"
          cat comment.md >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: trivy-scan
          message: ${{ steps.build.outputs.message }}
